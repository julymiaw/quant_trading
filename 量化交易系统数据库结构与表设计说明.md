# 量化交易系统数据库表结构与设计说明

---

## 1. 用户信息表（User）

| 字段名               | 类型                               | 说明                 | 约束/默认值   |
| -------------------- | ---------------------------------- | -------------------- | ------------- |
| user_id              | VARCHAR(50)                        | 用户唯一ID           | 主键          |
| user_account         | VARCHAR(50)                        | 用户账号             | 唯一，必填    |
| user_password        | VARCHAR(255)                       | 用户密码（加密存储） | 必填          |
| user_role            | ENUM('admin','analyst','viewer')   | 用户角色             | 默认 'viewer' |
| user_status          | ENUM('active','inactive','locked') | 用户状态             | 默认 'active' |
| user_email           | VARCHAR(100)                       | 邮箱                 | 可为空，索引  |
| user_phone           | VARCHAR(20)                        | 手机号               | 可为空        |
| user_create_time     | DATETIME                           | 创建时间             | 默认当前时间  |
| user_last_login_time | DATETIME                           | 最后登录时间         | 可为空        |

**主键**：user_id  
**唯一约束**：user_account  
**索引**：user_email

**用途说明**：  
用于存储系统所有用户的基本信息、账号状态和权限角色。支持管理员、分析师、普通查看者等多种角色管理，便于权限控制和审计。

---

## 2. 技术指标定义表（TechnicalIndicator）

| 字段名              | 类型                             | 说明                                                         | 约束/默认值 |
| ------------------- | -------------------------------- | ------------------------------------------------------------ | ----------- |
| indicator_id        | VARCHAR(50)                      | 技术指标唯一ID                                               | 主键        |
| indicator_name      | VARCHAR(100)                     | 技术指标名称                                                 | 必填        |
| indicator_type      | ENUM('technical', 'fundamental') | 指标类型：技术面或基本面                                     | 必填        |
| calculation_method  | TEXT                             | 技术指标的计算函数（技术面为函数表达式，基本面为表.字段名）  | 必填        |
| default_pre_period  | INT                              | 默认向前取历史天数（仅技术面指标有效）                       | 默认0       |
| default_post_period | INT                              | 默认向后预测天数（仅技术面指标有效，支持波动率等预测类指标） | 默认0       |
| description         | TEXT                             | 指标说明                                                     | 可为空      |
| is_active           | BOOLEAN                          | 是否启用该指标                                               | 默认TRUE    |

**主键**：indicator_id  
**索引**：indicator_type, is_active

**功能说明**：  
本表用于存储所有可用于量化回测与选股的技术指标定义。  
- 技术面指标（如MA、MACD、RSI等）通过 `calculation_method` 字段存储其计算函数，并支持 `default_pre_period`（向前取历史天数）和 `default_post_period`（向后预测天数，适用于波动率预测等AI类指标）。
- 基本面指标（如市值、市净率等）通过 `calculation_method` 字段存储为“表名.字段名”，不需要period相关字段，回测时直接查询每日指标表即可。

**使用场景**：  
- 回测时，系统会根据技术指标的定义，自动拉取所需的历史行情数据区间（start_date - pre_period 到 end_date + post_period），并调用对应的计算函数，生成日线级别的指标序列。
- 对于基本面指标，系统直接查询每日指标表，无需额外计算。

**注意事项**：  
- 技术面指标必须定义计算方法和period，基本面指标只需定义数据来源字段。
- 支持AI预测类技术指标（如波动率预测），允许设置向后预测

---

## 3. 策略表（Strategy）

| 字段名             | 类型                                 | 说明                                               | 约束/默认值  |
| ------------------ | ------------------------------------ | -------------------------------------------------- | ------------ |
| strategy_id        | VARCHAR(50)                          | 策略唯一ID                                         | 主键         |
| strategy_name      | VARCHAR(100)                         | 策略名称                                           | 必填         |
| strategy_type      | ENUM('builtin', 'custom')            | 策略类型：内置/自定义                              | 必填         |
| creator_id         | VARCHAR(50)                          | 创建者用户ID                                       | 外键，必填   |
| scope_type         | ENUM('all', 'single_stock', 'index') | 生效范围类型（全部、单只、指数成分股）             | 必填         |
| scope_id           | VARCHAR(50)                          | 股票ID或指数ID（仅当scope_type为单只或指数时填写） | 可为空       |
| position_count     | INT                                  | 持仓股票数量（仅全部/指数时有效）                  | 可为空       |
| rebalance_interval | INT                                  | 调仓间隔（单位：交易日，仅全部/指数时有效）        | 可为空       |
| buy_fee_rate       | DECIMAL(8,6)                         | 买入手续费率（如0.001表示千分之一）                | 默认0.001    |
| sell_fee_rate      | DECIMAL(8,6)                         | 卖出手续费率                                       | 默认0.001    |
| strategy_desc      | TEXT                                 | 策略描述                                           | 可为空       |
| create_time        | DATETIME                             | 创建时间                                           | 默认当前时间 |
| update_time        | DATETIME                             | 更新时间                                           | 自动更新     |

**主键**：strategy_id  
**索引**：creator_id, strategy_type, scope_type, scope_id  
**外键**：creator_id 关联 User(user_id)

**用途说明**：  
用于存储所有选股策略的基本信息，包括策略名称、类型、创建者、描述及创建/更新时间。  
支持灵活的策略生效范围（全部股票、单只股票、指数成分股），可配置持仓数量、调仓间隔、买卖手续费等属性，便于团队协作和策略管理，兼容聚宽等平台常见策略属性

---

## 4. 策略条件表（StrategyCondition）

| 字段名          | 类型                                                     | 说明                                     | 约束/默认值  |
| --------------- | -------------------------------------------------------- | ---------------------------------------- | ------------ |
| condition_id    | VARCHAR(50)                                              | 条件唯一ID                               | 主键         |
| strategy_id     | VARCHAR(50)                                              | 所属策略ID                               | 外键         |
| indicator_id    | VARCHAR(50)                                              | 技术指标ID                               | 外键         |
| condition_type  | ENUM('greater','less','between','cross_up','cross_down') | 条件类型（大于、小于、区间、上穿、下穿） | 必填         |
| threshold_min   | VARCHAR(50)                                              | 下界阈值（可为数值或指标ID）             | 可为空       |
| min_type        | ENUM('value','indicator')                                | 下界类型（数值/指标）                    | 可为空       |
| threshold_max   | VARCHAR(50)                                              | 上界阈值（可为数值或指标ID）             | 可为空       |
| max_type        | ENUM('value','indicator')                                | 上界类型（数值/指标）                    | 可为空       |
| signal_action   | ENUM('buy','sell','risk_control')                        | 信号类型（买入/卖出/风险控制）           | 必填         |
| condition_order | INT                                                      | 条件顺序                                 | 必填，正整数 |

**逻辑说明**：
- 买入/卖出信号为“与”关系，需全部满足才触发；
- 风险控制信号为“或”关系，任一条件满足即触发风险控制卖出；
- 上下界可为数值或指标ID，需通过 `min_type`、`max_type` 区分；
- 支持大数值（如市值20亿）和指标间比较。

---

## 5. 交易信号表（TradingSignal）

| 字段名         | 类型                                | 说明             | 约束/默认值  |
| -------------- | ----------------------------------- | ---------------- | ------------ |
| signal_id      | VARCHAR(50)                         | 信号唯一ID       | 主键         |
| user_id        | VARCHAR(50)                         | 生成信号的用户ID | 外键         |
| strategy_id    | VARCHAR(50)                         | 来源策略ID       | 外键         |
| stock_code     | VARCHAR(20)                         | 股票代码         | 必填         |
| trade_date     | DATE                                | 信号生成日期     | 必填         |
| signal_type    | ENUM('buy', 'sell', 'risk_control') | 信号类型         | 必填         |
| trigger_reason | VARCHAR(500)                        | 触发原因         | 可为空       |
| generate_time  | DATETIME                            | 信号生成时间     | 默认当前时间 |

**主键**：signal_id  
**索引**：user_id, strategy_id, stock_code, trade_date  
**外键**：user_id 关联 User(user_id)，strategy_id 关联 Strategy(strategy_id)

**用途说明**：  
用于记录系统生成的所有交易信号，包括买入、卖出和风险控制信号。信号价格和置信度不再冗余存储，相关信息可通过行情表查询。信号类型与策略条件表保持一致，便于统一处理和回

---

## 6. 回测报告表（BacktestReport）

| 字段名               | 类型                                      | 说明                               | 约束/默认值       |
| -------------------- | ----------------------------------------- | ---------------------------------- | ----------------- |
| report_id            | VARCHAR(50)                               | 回测报告唯一ID                     | 主键              |
| strategy_id          | VARCHAR(50)                               | 策略ID                             | 外键              |
| user_id              | VARCHAR(50)                               | 用户ID                             | 外键              |
| backtest_type        | ENUM('STOCK', 'INDEX')                    | 回测类型（单股票/指数）            | 默认 'STOCK'      |
| stock_code           | VARCHAR(20)                               | 单股票代码或指数代码               | 必填              |
| component_count      | INT                                       | 指数成分股数量（仅指数回测时有效） | 可为空            |
| start_date           | DATE                                      | 回测起始日期                       | 必填              |
| end_date             | DATE                                      | 回测结束日期                       | 必填              |
| initial_fund         | DECIMAL(15,2)                             | 初始资金                           | 必填              |
| final_fund           | DECIMAL(15,2)                             | 回测结束资金                       | 必填              |
| total_return         | DECIMAL(8,4)                              | 总收益率                           | 必填              |
| annual_return        | DECIMAL(8,4)                              | 年化收益率                         | 必填              |
| max_drawdown         | DECIMAL(8,4)                              | 最大回撤                           | 必填              |
| sharpe_ratio         | DECIMAL(8,4)                              | 夏普比率                           | 可为空            |
| win_rate             | DECIMAL(5,4)                              | 胜率                               | 可为空            |
| profit_loss_ratio    | DECIMAL(8,4)                              | 盈亏比                             | 可为空            |
| trade_count          | INT                                       | 交易次数                           | 必填              |
| report_generate_time | DATETIME                                  | 报告生成时间                       | 默认当前时间      |
| report_status        | ENUM('generating', 'completed', 'failed') | 报告状态                           | 默认 'generating' |

**主键**：report_id  
**索引**：strategy_id, user_id, stock_code, backtest_type  
**外键**：strategy_id 关联 Strategy(strategy_id)，user_id 关联 User(user_id)

**用途说明**：  
用于存储每次回测的详细结果，包括回测类型（单股票或指数）、回测区间、资金变化、收益率、回撤、夏普比率、胜率、盈亏比、交易次数等核心指标，便于后续分析和对比

---

## 7. 系统日志表（SystemLog）

| 字段名            | 类型                                                                         | 说明               | 约束/默认值  |
| ----------------- | ---------------------------------------------------------------------------- | ------------------ | ------------ |
| log_id            | VARCHAR(50)                                                                  | 日志唯一ID         | 主键         |
| operator_id       | VARCHAR(50)                                                                  | 操作用户ID         | 外键，可为空 |
| operator_role     | ENUM('admin', 'analyst', 'viewer', 'system')                                 | 操作用户角色或系统 | 可为空       |
| operation_type    | ENUM('login', 'strategy_create', 'backtest', 'signal_generate', 'data_sync') | 操作类型           | 必填         |
| operation_content | TEXT                                                                         | 操作内容描述       | 必填         |
| operation_time    | DATETIME                                                                     | 操作时间           | 默认当前时间 |
| operation_result  | ENUM('success', 'failed', 'warning')                                         | 操作结果           | 必填         |
| error_info        | TEXT                                                                         | 错误信息（如有）   | 可为空       |

**主键**：log_id  
**索引**：operator_id, operation_type, operation_time  
**外键**：operator_id 关联 User(user_id)，删除用户时置空

**用途说明**：  
用于记录系统各类操作日志，包括用户操作、策略创建、回测、信号生成、数据同步等，便于系统审计、问题追踪和安全管理。
