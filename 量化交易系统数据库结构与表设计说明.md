# 量化交易系统数据库表结构与设计说明（2025-09修订）

---

## 1. 用户信息表（User）

用于存储系统所有用户的基本信息、账号状态和权限角色。用户名唯一，仅允许英文、数字、下划线，不能与Tushare表名重复。

| 字段名               | 类型                               | 说明                 | 约束/默认值    |
| -------------------- | ---------------------------------- | -------------------- | -------------- |
| user_id              | VARCHAR(50)                        | 用户唯一ID           | 主键           |
| user_name            | VARCHAR(50)                        | 用户名               | 唯一，必填     |
| user_password        | VARCHAR(255)                       | 用户密码（加密存储） | 必填           |
| user_role            | ENUM('admin','analyst')            | 用户角色             | 默认 'analyst' |
| user_status          | ENUM('active','inactive','locked') | 用户状态             | 默认 'active'  |
| user_email           | VARCHAR(100)                       | 邮箱                 | 可为空，索引   |
| user_phone           | VARCHAR(20)                        | 手机号               | 可为空         |
| user_create_time     | DATETIME                           | 创建时间             | 默认当前时间   |
| user_last_login_time | DATETIME                           | 最后登录时间         | 可为空         |

**主键**：user_id  
**唯一约束**：user_name  
**索引**：user_email

**示例数据：**

| user_id | user_name | user_password | user_role | user_status | user_email | user_phone | user_create_time | user_last_login_time |
| ------- | --------- | ------------- | --------- | ----------- | ---------- | ---------- | ---------------- | -------------------- |
| 1       | system    | ******        | admin     | active      |            |            | 2025-09-01       | 2025-09-10           |

---

## 2. 指标表（Indicator）

用于存储所有可用于量化回测与选股的技术/自定义指标定义。每个指标由创建者和指标名唯一确定，支持自定义计算函数。

| 字段名             | 类型         | 说明                       | 约束/默认值 |
| ------------------ | ------------ | -------------------------- | ----------- |
| creator_name       | VARCHAR(50)  | 指标创建者用户名           | 外键        |
| indicator_name     | VARCHAR(100) | 指标名称                   | 主键        |
| calculation_method | TEXT         | 指标计算函数（Python代码） | 必填        |
| description        | TEXT         | 指标说明                   | 可为空      |
| is_active          | BOOLEAN      | 是否启用                   | 默认TRUE    |

**主键**：creator_name, indicator_name  
**索引**：creator_name, is_active

**示例数据（MACD指标）：**

| creator_name | indicator_name | calculation_method | description            | is_active |
| ------------ | -------------- | ------------------ | ---------------------- | --------- |
| system       | MACD           | 见下方代码块       | MACD线=12日EMA-26日EMA | TRUE      |

**MACD calculation_method 示例代码：**
```python
def calculation_method(params):
    return params.daily_ema_12 - params.daily_ema_26
```

---

## 3. 参数表（Param）

结构化存储每个指标或策略的参数定义。通过 param_owner_type 区分参数归属（指标或策略），支持聚合函数、引用其他指标等。

| 字段名           | 类型         | 说明                                        | 约束/默认值 |
| ---------------- | ------------ | ------------------------------------------- | ----------- |
| param_owner_type | ENUM         | 参数归属类型：indicator/strategy            | 必填        |
| owner_name       | VARCHAR(100) | 归属对象名（indicator_name或strategy_name） | 必填        |
| creator_name     | VARCHAR(50)  | 归属对象创建者用户名                        | 必填        |
| param_id         | VARCHAR(50)  | 参数唯一ID（如daily_ema_12）                | 必填        |
| data_id          | VARCHAR(100) | 数据来源ID，如daily.close或system.MACD      | 必填        |
| param_type       | ENUM         | table=查Tushare表，indicator=引用其他指标   | 必填        |
| pre_period       | INT          | 向前取历史天数                              | 默认0       |
| post_period      | INT          | 向后预测天数                                | 默认0       |
| agg_func         | VARCHAR(50)  | 聚合函数，如SMA、EMA、MAX等                 | 可为空      |

**主键**：param_owner_type, creator_name, owner_name, param_id  
**索引**：param_owner_type, creator_name, owner_name

**示例数据：**

| param_owner_type | owner_name | creator_name | param_id     | data_id              | param_type | pre_period | post_period | agg_func |
| ---------------- | ---------- | ------------ | ------------ | -------------------- | ---------- | ---------- | ----------- | -------- |
| indicator        | MACD       | system       | daily_ema_12 | daily.close          | table      | 12         | 0           | EMA      |
| indicator        | MACD       | system       | daily_ema_26 | daily.close          | table      | 26         | 0           | EMA      |
| strategy         | 小市值策略 | system       | total_mv     | daily_basic.total_mv | table      | 0          | 0           |          |
| strategy         | 双均线策略 | system       | close        | daily.close          | table      | 0          | 0           |          |
| strategy         | 双均线策略 | system       | ema_5        | daily.close          | table      | 5          | 0           | EMA      |
| strategy         | MACD策略   | system       | macd_ema_9   | system.MACD          | indicator  | 9          | 0           | EMA      |
| strategy         | MACD策略   | system       | close        | daily.close          | table      | 0          | 0           |          |
| strategy         | 风控函数   | system       | ema_60       | daily.close          | table      | 60         | 0           | EMA      |
| strategy         | 风控函数   | system       | close        | daily.close          | table      | 0          | 0           |          |

---

## 4. 策略表（Strategy）

用于存储所有选股策略的基本信息，包括策略名称、创建者、描述、调仓函数、风险控制函数等。每个策略由创建者和策略名唯一确定。

| 字段名             | 类型                                 | 说明                                               | 约束/默认值  |
| ------------------ | ------------------------------------ | -------------------------------------------------- | ------------ |
| creator_name       | VARCHAR(50)                          | 策略创建者用户名                                   | 外键         |
| strategy_name      | VARCHAR(100)                         | 策略名称                                           | 主键         |
| public             | BOOLEAN                              | 是否公开（管理员创建的为public，用户可选）         | 默认TRUE     |
| scope_type         | ENUM('all', 'single_stock', 'index') | 生效范围类型（全部、单只、指数成分股）             | 必填         |
| scope_id           | VARCHAR(50)                          | 股票ID或指数ID（仅当scope_type为单只或指数时填写） | 可为空       |
| select_func        | TEXT                                 | 调仓选股函数（Python代码）                         | 必填         |
| risk_control_func  | TEXT                                 | 风险控制函数（Python代码）                         | 可为空       |
| position_count     | INT                                  | 持仓股票数量（仅全部/指数时有效）                  | 可为空       |
| rebalance_interval | INT                                  | 调仓间隔（单位：交易日，仅全部/指数时有效）        | 可为空       |
| buy_fee_rate       | DECIMAL(8,6)                         | 买入手续费率（如0.001表示千分之一）                | 默认0.001    |
| sell_fee_rate      | DECIMAL(8,6)                         | 卖出手续费率                                       | 默认0.001    |
| strategy_desc      | TEXT                                 | 策略描述                                           | 可为空       |
| create_time        | DATETIME                             | 创建时间                                           | 默认当前时间 |
| update_time        | DATETIME                             | 更新时间                                           | 自动更新     |

**主键**：creator_name, strategy_name  
**索引**：creator_name, scope_type, scope_id

---

### 示例数据

#### 小市值策略

| creator_name | strategy_name | public | scope_type | scope_id | position_count | rebalance_interval | buy_fee_rate | sell_fee_rate | strategy_desc              |
| ------------ | ------------- | ------ | ---------- | -------- | -------------- | ------------------ | ------------ | ------------- | -------------------------- |
| system       | 小市值策略    | TRUE   | all        |          | 3              | 5                  | 0.0003       | 0.0013        | 市值20-30亿，市值最小的3只 |

**select_func 示例代码：**
```python
def select_func(candidates, indicators, position_count, current_holdings, date, context=None):
    # 只选市值在20亿到30亿之间的股票
    filtered = [s for s in candidates if 2e9 <= indicators[s]['total_mv'] <= 3e9]
    # 按市值从小到大排序，选最小的position_count只
    sorted_stocks = sorted(filtered, key=lambda s: indicators[s]['total_mv'])
    return sorted_stocks[:position_count]
```

**risk_control_func 示例代码（所有策略共用）：**
```python
def risk_control_func(current_holdings, indicators, date, context=None):
    # 60日均线下穿日线时全部卖出
    sell_list = []
    for stock in current_holdings:
        if indicators[stock]['ema_60'] > indicators[stock]['close']:
            sell_list.append(stock)
    return [h for h in current_holdings if h not in sell_list]
```

---

#### 双均线策略

| creator_name | strategy_name | public | scope_type   | scope_id    | position_count | rebalance_interval | buy_fee_rate | sell_fee_rate | strategy_desc                  |
| ------------ | ------------- | ------ | ------------ | ----------- | -------------- | ------------------ | ------------ | ------------- | ------------------------------ |
| system       | 双均线策略    | TRUE   | single_stock | 000001.XSHE | 1              | 1                  | 0.0003       | 0.0013        | 5日均线上穿/下穿日线，择时买卖 |

**select_func 示例代码：**
```python
def select_func(candidates, indicators, position_count, current_holdings, date, context=None):
    # 只对单只股票
    stock = candidates[0]
    close = indicators[stock]['close']
    ema_5 = indicators[stock]['ema_5']
    # 买入条件：价格高于5日均线1%
    if close > 1.01 * ema_5:
        return [stock]
    # 卖出条件：价格低于5日均线
    elif close < ema_5:
        return []
    # 否则保持原有持仓
    return current_holdings
```

**risk_control_func** 同上。

---

#### MACD策略

| creator_name | strategy_name | public | scope_type   | scope_id    | position_count | rebalance_interval | buy_fee_rate | sell_fee_rate | strategy_desc                   |
| ------------ | ------------- | ------ | ------------ | ----------- | -------------- | ------------------ | ------------ | ------------- | ------------------------------- |
| system       | MACD策略      | TRUE   | single_stock | 000001.XSHE | 1              | 1                  | 0.0003       | 0.0013        | 9日MACD线下穿日线买入，上穿卖出 |

**select_func 示例代码：**
```python
def select_func(candidates, indicators, position_count, current_holdings, date, context=None):
    stock = candidates[0]
    macd_ema_9 = indicators[stock]['macd_ema_9']
    close = indicators[stock]['close']
    # 下穿买入
    if macd_ema_9 < close:
        return [stock]
    # 上穿卖出
    elif macd_ema_9 > close:
        return []
    return current_holdings
```

**risk_control_func** 同上。

---

## 5. 交易信号表（TradingSignal）

用于记录系统生成的所有交易信号，包括买入、卖出和风险控制信号。信号价格和置信度不再冗余存储，相关信息可通过行情表查询。

| 字段名         | 类型                                | 说明             | 约束/默认值  |
| -------------- | ----------------------------------- | ---------------- | ------------ |
| signal_id      | VARCHAR(50)                         | 信号唯一ID       | 主键         |
| user_name      | VARCHAR(50)                         | 生成信号的用户名 | 外键         |
| creator_name   | VARCHAR(50)                         | 策略创建者用户名 | 外键         |
| strategy_name  | VARCHAR(100)                        | 策略名称         | 外键         |
| stock_code     | VARCHAR(20)                         | 股票代码         | 必填         |
| trade_date     | DATE                                | 信号生成日期     | 必填         |
| signal_type    | ENUM('buy', 'sell', 'risk_control') | 信号类型         | 必填         |
| trigger_reason | VARCHAR(500)                        | 触发原因         | 可为空       |
| generate_time  | DATETIME                            | 信号生成时间     | 默认当前时间 |

---

## 6. 回测报告表（BacktestReport）

用于存储每次回测的详细结果，包括回测类型（单股票或指数）、回测区间、资金变化、收益率、回撤、夏普比率、胜率、盈亏比、交易次数等核心指标，便于后续分析和对比。

| 字段名               | 类型                                      | 说明                               | 约束/默认值       |
| -------------------- | ----------------------------------------- | ---------------------------------- | ----------------- |
| report_id            | VARCHAR(50)                               | 回测报告唯一ID                     | 主键              |
| creator_name         | VARCHAR(50)                               | 策略创建者用户名                   | 外键              |
| strategy_name        | VARCHAR(100)                              | 策略名称                           | 外键              |
| user_name            | VARCHAR(50)                               | 回测发起用户                       | 外键              |
| backtest_type        | ENUM('STOCK', 'INDEX')                    | 回测类型（单股票/指数）            | 默认 'STOCK'      |
| stock_code           | VARCHAR(20)                               | 单股票代码或指数代码               | 必填              |
| component_count      | INT                                       | 指数成分股数量（仅指数回测时有效） | 可为空            |
| start_date           | DATE                                      | 回测起始日期                       | 必填              |
| end_date             | DATE                                      | 回测结束日期                       | 必填              |
| initial_fund         | DECIMAL(15,2)                             | 初始资金                           | 必填              |
| final_fund           | DECIMAL(15,2)                             | 回测结束资金                       | 必填              |
| total_return         | DECIMAL(8,4)                              | 总收益率                           | 必填              |
| annual_return        | DECIMAL(8,4)                              | 年化收益率                         | 必填              |
| max_drawdown         | DECIMAL(8,4)                              | 最大回撤                           | 必填              |
| sharpe_ratio         | DECIMAL(8,4)                              | 夏普比率                           | 可为空            |
| win_rate             | DECIMAL(5,4)                              | 胜率                               | 可为空            |
| profit_loss_ratio    | DECIMAL(8,4)                              | 盈亏比                             | 可为空            |
| trade_count          | INT                                       | 交易次数                           | 必填              |
| report_generate_time | DATETIME                                  | 报告生成时间                       | 默认当前时间      |
| report_status        | ENUM('generating', 'completed', 'failed') | 报告状态                           | 默认 'generating' |

---

## 7. 系统日志表（SystemLog）

用于记录系统各类操作日志，包括用户操作、策略创建、回测、信号生成、数据同步等，便于系统审计、问题追踪和安全管理。

| 字段名            | 类型                                                                         | 说明               | 约束/默认值  |
| ----------------- | ---------------------------------------------------------------------------- | ------------------ | ------------ |
| log_id            | VARCHAR(50)                                                                  | 日志唯一ID         | 主键         |
| operator_name     | VARCHAR(50)                                                                  | 操作用户           | 外键，可为空 |
| operator_role     | ENUM('admin', 'analyst', 'system')                                           | 操作用户角色或系统 | 可为空       |
| operation_type    | ENUM('login', 'strategy_create', 'backtest', 'signal_generate', 'data_sync') | 操作类型           | 必填         |
| operation_content | TEXT                                                                         | 操作内容描述       | 必填         |
| operation_time    | DATETIME                                                                     | 操作时间           | 默认当前时间 |
| operation_result  | ENUM('success', 'failed', 'warning')                                         | 操作结果           | 必填         |
| error_info        | TEXT                                                                         | 错误信息（如有）   | 可为空       |

---
