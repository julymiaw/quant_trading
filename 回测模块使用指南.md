# 量化交易系统 - 回测模块使用指南

## 📋 概述

`backtest_engine.py` 是量化交易系统的回测模块封装，它基于现有的回测逻辑创建，完全兼容原有代码结构，并提供了更强的功能扩展。

## 🎯 核心特性

### 1. **双模式数据输入**

- ✅ **文件模式**: 从CSV和JSON文件读取数据（兼容现有格式）
- ✅ **直接模式**: 接收数据准备模块的输出，跳过文件系统

### 2. **完整的回测功能**

- ✅ **策略执行**: 完全兼容现有的选股函数和风控函数
- ✅ **交易记录**: 详细的买卖信号、价格、手续费记录
- ✅ **性能分析**: 夏普比率、最大回撤、胜率等指标

### 3. **多格式图表输出**

- ✅ **Matplotlib**: 生成base64编码的PNG图片
- ✅ **Plotly HTML**: 生成交互式HTML图表
- ✅ **Plotly JSON**: 返回JSON数据供前端渲染

## 🚀 快速使用

### 方法1: 从文件运行回测

```python
from backtest_engine import run_backtest_from_files

# 运行双均线策略
results, engine = run_backtest_from_files(
    csv_path="data_prepared/system_双均线策略/prepared_data_params.csv",
    json_path="data_prepared/system_双均线策略/prepared_data.json",
    initial_fund=100000.0,
    buy_fee_rate=0.0003,
    sell_fee_rate=0.0013,
    print_log=True
)

print(f"总收益率: {results['total_return']:.2%}")
```

### 方法2: 从数据字典运行回测

```python
from backtest_engine import run_backtest_from_data

# 假设data_dict来自数据准备模块
results, engine = run_backtest_from_data(
    data_dict=prepared_data,  # 来自prepare_strategy_data.py
    initial_fund=100000.0,
    buy_fee_rate=0.0003,
    sell_fee_rate=0.0013
)
```

### 方法3: 使用BacktestEngine类

```python
from backtest_engine import BacktestEngine

engine = BacktestEngine(initial_fund=100000.0, buy_fee_rate=0.0003, sell_fee_rate=0.0013)

# 加载数据
config = engine.load_data_from_file(csv_path, json_path)

# 运行回测
results = engine.run_backtest(config, print_log=True)

# 生成图表
plot_base64 = engine.generate_matplotlib_plot()
html_plot = engine.generate_plotly_html("策略回测结果")
```

## 📊 输出结果格式

### 回测结果字典

```python
{
    'initial_value': 100000.0,      # 初始资金
    'final_value': 96972.82,        # 最终资金
    'total_return': -0.0303,        # 总收益率
    'strategy_pnl': -3027.18,       # 策略收益
    'analysis': {
        'sharpe_ratio': 0.0000,     # 夏普比率
        'max_drawdown': 319.99,     # 最大回撤(%)
        'win_rate': 0.50,           # 胜率
        'won_total': 2,             # 盈利次数
        'lost_total': 2,            # 亏损次数
        'total_trades': 4           # 总交易次数
    },
    'strategy_info': {...},         # 策略信息
    'commission_info': {...}        # 手续费信息
}
```

## 🧪 测试结果

### 测试1: 双均线策略 (2025-08-01 to 2025-08-29)

```plaintext
初始资金: ¥100,000.00
最终资金: ¥96,972.82
总收益率: -3.03%
夏普比率: 0.0000
最大回撤: 319.99%
胜率: 50.00%
交易次数: 4次 (盈利2次，亏损2次)
```

### 测试2: MACD策略 (2025-08-01 to 2025-08-29)

```plaintext
初始资金: ¥100,000.00
最终资金: ¥97,909.38
总收益率: -2.09%
夏普比率: 0.0000
最大回撤: 385.17%
胜率: 25.00%
交易次数: 4次 (盈利1次，亏损3次)
```

## 🔧 核心类和函数

### 1. BacktestEngine 类

主要的回测引擎类，提供完整的回测功能。

**主要方法**:

- `load_data_from_file()`: 从文件加载数据
- `load_data_direct()`: 直接接收数据字典
- `run_backtest()`: 执行回测
- `generate_matplotlib_plot()`: 生成matplotlib图表
- `generate_plotly_html()`: 生成交互式HTML图表
- `generate_plotly_json()`: 生成Plotly JSON数据

### 2. TestStrategy 类

核心策略执行类，完全兼容现有逻辑，包含:

- 选股逻辑执行
- 风险控制执行
- 交易信号生成
- 性能统计

### 3. 便捷函数

- `run_backtest_from_files()`: 从文件运行回测
- `run_backtest_from_data()`: 从数据运行回测
- `create_dynamic_data_class()`: 动态创建数据类

## 🎨 图表生成

### Matplotlib图表

```python
# 生成base64编码的PNG图片
plot_base64 = engine.generate_matplotlib_plot()
# 返回格式: "data:image/png;base64,iVBORw0KGgoAAAA..."
```

### Plotly交互式图表

```python
# 生成HTML文件
html_plot = engine.generate_plotly_html("回测结果")
with open("result.html", "w", encoding="utf-8") as f:
    f.write(html_plot)

# 生成JSON数据供前端使用
json_data = engine.generate_plotly_json("回测结果")
```

## 🔌 与后端API集成

回测模块设计时充分考虑了与Flask后端的集成：

```python
# 在Flask API中使用
@app.route("/api/backtest/run", methods=["POST"])
@token_required
def run_backtest_api(current_user):
    # 从数据准备模块获取数据
    data_dict = prepare_strategy_data(...)
    
    # 运行回测
    results, engine = run_backtest_from_data(data_dict)
    
    # 生成图表
    plot_json = engine.generate_plotly_json()
    
    return jsonify({
        "results": results,
        "plot_data": plot_json
    })
```

## ⚠️ 注意事项

### 1. 依赖要求

```bash
# 必需依赖
pip install backtrader pandas numpy matplotlib

# 可选依赖（用于交互式图表）
pip install plotly
```

### 2. 数据格式要求

- CSV文件必须包含: `ts_code`, `system.open`, `system.close`, `system.high`, `system.low`
- JSON文件必须包含: `select_func`, `risk_control_func`, `param_columns`

### 3. 策略函数格式

策略函数必须遵循现有格式:

```python
def select_func(candidates, params, position_count, current_holdings, date, context=None):
    # 选股逻辑
    return selected_stocks

def risk_control_func(current_holdings, params, date, context=None):
    # 风控逻辑
    return safe_holdings
```

## 🚀 后续计划

1. **实时数据源集成**: 支持实时行情数据回测
2. **更多分析指标**: 增加更丰富的性能分析指标
3. **基准对比**: 支持与基准指数的对比分析
4. **多策略组合**: 支持多策略组合回测
5. **参数优化**: 支持策略参数自动优化

## 📁 相关文件

- `backtest_engine.py`: 回测引擎主文件
- `backtest_result.html`: 双均线策略回测图表（模拟数据）  
- `real_data_backtest_result.html`: 双均线策略真实数据图表
- `macd_real_data_result.html`: MACD策略真实数据图表
- `backtrader/`: 原始回测代码目录
- `data_prepared/`: 准备好的回测数据

## 🔧 重要修复说明

### Plotly真实数据集成 (v1.1)

**问题**: 之前版本的plotly图表使用的是模拟随机数据，没有反映真实的回测结果。

**解决方案**:

1. 新增 `PortfolioValue` 自定义分析器，在回测过程中记录每日资产价值
2. 修改 `generate_plotly_html()` 和 `generate_plotly_json()` 方法，从真实回测数据中提取：
   - 每日资产价值变化
   - 累计收益率曲线
   - 实际交易日期范围

**验证结果**:

- 双均线策略：21天真实数据，收益率-3.03%
- MACD策略：242天真实数据，收益率+14.41%

现在plotly图表准确反映了回测的真实表现，包括双Y轴显示（资产价值 + 收益率%）。

## 📞 联系信息

如需技术支持或功能扩展，请参考项目文档或联系开发团队。
