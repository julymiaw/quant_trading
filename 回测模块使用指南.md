# é‡åŒ–äº¤æ˜“ç³»ç»Ÿ - å›æµ‹æ¨¡å—ä½¿ç”¨æŒ‡å—

## ğŸ“‹ æ¦‚è¿°

`backtest_engine.py` æ˜¯é‡åŒ–äº¤æ˜“ç³»ç»Ÿçš„å›æµ‹æ¨¡å—å°è£…ï¼Œå®ƒåŸºäºç°æœ‰çš„å›æµ‹é€»è¾‘åˆ›å»ºï¼Œå®Œå…¨å…¼å®¹åŸæœ‰ä»£ç ç»“æ„ï¼Œå¹¶æä¾›äº†æ›´å¼ºçš„åŠŸèƒ½æ‰©å±•ã€‚

## ğŸ¯ æ ¸å¿ƒç‰¹æ€§

### 1. **åŒæ¨¡å¼æ•°æ®è¾“å…¥**
- âœ… **æ–‡ä»¶æ¨¡å¼**: ä»CSVå’ŒJSONæ–‡ä»¶è¯»å–æ•°æ®ï¼ˆå…¼å®¹ç°æœ‰æ ¼å¼ï¼‰
- âœ… **ç›´æ¥æ¨¡å¼**: æ¥æ”¶æ•°æ®å‡†å¤‡æ¨¡å—çš„è¾“å‡ºï¼Œè·³è¿‡æ–‡ä»¶ç³»ç»Ÿ

### 2. **å®Œæ•´çš„å›æµ‹åŠŸèƒ½**
- âœ… **ç­–ç•¥æ‰§è¡Œ**: å®Œå…¨å…¼å®¹ç°æœ‰çš„é€‰è‚¡å‡½æ•°å’Œé£æ§å‡½æ•°
- âœ… **äº¤æ˜“è®°å½•**: è¯¦ç»†çš„ä¹°å–ä¿¡å·ã€ä»·æ ¼ã€æ‰‹ç»­è´¹è®°å½•
- âœ… **æ€§èƒ½åˆ†æ**: å¤æ™®æ¯”ç‡ã€æœ€å¤§å›æ’¤ã€èƒœç‡ç­‰æŒ‡æ ‡

### 3. **å¤šæ ¼å¼å›¾è¡¨è¾“å‡º**
- âœ… **Matplotlib**: ç”Ÿæˆbase64ç¼–ç çš„PNGå›¾ç‰‡
- âœ… **Plotly HTML**: ç”Ÿæˆäº¤äº’å¼HTMLå›¾è¡¨
- âœ… **Plotly JSON**: è¿”å›JSONæ•°æ®ä¾›å‰ç«¯æ¸²æŸ“

## ğŸš€ å¿«é€Ÿä½¿ç”¨

### æ–¹æ³•1: ä»æ–‡ä»¶è¿è¡Œå›æµ‹

```python
from backtest_engine import run_backtest_from_files

# è¿è¡ŒåŒå‡çº¿ç­–ç•¥
results, engine = run_backtest_from_files(
    csv_path="data_prepared/system_åŒå‡çº¿ç­–ç•¥/prepared_data_params.csv",
    json_path="data_prepared/system_åŒå‡çº¿ç­–ç•¥/prepared_data.json",
    initial_cash=100000.0,
    commission=0.001,
    print_log=True
)

print(f"æ€»æ”¶ç›Šç‡: {results['total_return']:.2%}")
```

### æ–¹æ³•2: ä»æ•°æ®å­—å…¸è¿è¡Œå›æµ‹

```python
from backtest_engine import run_backtest_from_data

# å‡è®¾data_dictæ¥è‡ªæ•°æ®å‡†å¤‡æ¨¡å—
results, engine = run_backtest_from_data(
    data_dict=prepared_data,  # æ¥è‡ªprepare_strategy_data.py
    initial_cash=100000.0,
    commission=0.001
)
```

### æ–¹æ³•3: ä½¿ç”¨BacktestEngineç±»

```python
from backtest_engine import BacktestEngine

engine = BacktestEngine(initial_cash=100000.0, commission=0.001)

# åŠ è½½æ•°æ®
config = engine.load_data_from_file(csv_path, json_path)

# è¿è¡Œå›æµ‹
results = engine.run_backtest(config, print_log=True)

# ç”Ÿæˆå›¾è¡¨
plot_base64 = engine.generate_matplotlib_plot()
html_plot = engine.generate_plotly_html("ç­–ç•¥å›æµ‹ç»“æœ")
```

## ğŸ“Š è¾“å‡ºç»“æœæ ¼å¼

### å›æµ‹ç»“æœå­—å…¸
```python
{
    'initial_value': 100000.0,      # åˆå§‹èµ„é‡‘
    'final_value': 96972.82,        # æœ€ç»ˆèµ„é‡‘
    'total_return': -0.0303,        # æ€»æ”¶ç›Šç‡
    'strategy_pnl': -3027.18,       # ç­–ç•¥æ”¶ç›Š
    'analysis': {
        'sharpe_ratio': 0.0000,     # å¤æ™®æ¯”ç‡
        'max_drawdown': 319.99,     # æœ€å¤§å›æ’¤(%)
        'win_rate': 0.50,           # èƒœç‡
        'won_total': 2,             # ç›ˆåˆ©æ¬¡æ•°
        'lost_total': 2,            # äºæŸæ¬¡æ•°
        'total_trades': 4           # æ€»äº¤æ˜“æ¬¡æ•°
    },
    'strategy_info': {...},         # ç­–ç•¥ä¿¡æ¯
    'commission_info': {...}        # æ‰‹ç»­è´¹ä¿¡æ¯
}
```

## ğŸ§ª æµ‹è¯•ç»“æœ

### æµ‹è¯•1: åŒå‡çº¿ç­–ç•¥ (2025-08-01 to 2025-08-29)
```
åˆå§‹èµ„é‡‘: Â¥100,000.00
æœ€ç»ˆèµ„é‡‘: Â¥96,972.82
æ€»æ”¶ç›Šç‡: -3.03%
å¤æ™®æ¯”ç‡: 0.0000
æœ€å¤§å›æ’¤: 319.99%
èƒœç‡: 50.00%
äº¤æ˜“æ¬¡æ•°: 4æ¬¡ (ç›ˆåˆ©2æ¬¡ï¼ŒäºæŸ2æ¬¡)
```

### æµ‹è¯•2: MACDç­–ç•¥ (2025-08-01 to 2025-08-29)
```
åˆå§‹èµ„é‡‘: Â¥100,000.00
æœ€ç»ˆèµ„é‡‘: Â¥97,909.38
æ€»æ”¶ç›Šç‡: -2.09%
å¤æ™®æ¯”ç‡: 0.0000
æœ€å¤§å›æ’¤: 385.17%
èƒœç‡: 25.00%
äº¤æ˜“æ¬¡æ•°: 4æ¬¡ (ç›ˆåˆ©1æ¬¡ï¼ŒäºæŸ3æ¬¡)
```

## ğŸ”§ æ ¸å¿ƒç±»å’Œå‡½æ•°

### 1. BacktestEngine ç±»
ä¸»è¦çš„å›æµ‹å¼•æ“ç±»ï¼Œæä¾›å®Œæ•´çš„å›æµ‹åŠŸèƒ½ã€‚

**ä¸»è¦æ–¹æ³•**:
- `load_data_from_file()`: ä»æ–‡ä»¶åŠ è½½æ•°æ®
- `load_data_direct()`: ç›´æ¥æ¥æ”¶æ•°æ®å­—å…¸
- `run_backtest()`: æ‰§è¡Œå›æµ‹
- `generate_matplotlib_plot()`: ç”Ÿæˆmatplotlibå›¾è¡¨
- `generate_plotly_html()`: ç”Ÿæˆäº¤äº’å¼HTMLå›¾è¡¨
- `generate_plotly_json()`: ç”ŸæˆPlotly JSONæ•°æ®

### 2. TestStrategy ç±»
æ ¸å¿ƒç­–ç•¥æ‰§è¡Œç±»ï¼Œå®Œå…¨å…¼å®¹ç°æœ‰é€»è¾‘ï¼ŒåŒ…å«:
- é€‰è‚¡é€»è¾‘æ‰§è¡Œ
- é£é™©æ§åˆ¶æ‰§è¡Œ
- äº¤æ˜“ä¿¡å·ç”Ÿæˆ
- æ€§èƒ½ç»Ÿè®¡

### 3. ä¾¿æ·å‡½æ•°
- `run_backtest_from_files()`: ä»æ–‡ä»¶è¿è¡Œå›æµ‹
- `run_backtest_from_data()`: ä»æ•°æ®è¿è¡Œå›æµ‹
- `create_dynamic_data_class()`: åŠ¨æ€åˆ›å»ºæ•°æ®ç±»

## ğŸ¨ å›¾è¡¨ç”Ÿæˆ

### Matplotlibå›¾è¡¨
```python
# ç”Ÿæˆbase64ç¼–ç çš„PNGå›¾ç‰‡
plot_base64 = engine.generate_matplotlib_plot()
# è¿”å›æ ¼å¼: "data:image/png;base64,iVBORw0KGgoAAAA..."
```

### Plotlyäº¤äº’å¼å›¾è¡¨
```python
# ç”ŸæˆHTMLæ–‡ä»¶
html_plot = engine.generate_plotly_html("å›æµ‹ç»“æœ")
with open("result.html", "w", encoding="utf-8") as f:
    f.write(html_plot)

# ç”ŸæˆJSONæ•°æ®ä¾›å‰ç«¯ä½¿ç”¨
json_data = engine.generate_plotly_json("å›æµ‹ç»“æœ")
```

## ğŸ”Œ ä¸åç«¯APIé›†æˆ

å›æµ‹æ¨¡å—è®¾è®¡æ—¶å……åˆ†è€ƒè™‘äº†ä¸Flaskåç«¯çš„é›†æˆï¼š

```python
# åœ¨Flask APIä¸­ä½¿ç”¨
@app.route("/api/backtest/run", methods=["POST"])
@token_required
def run_backtest_api(current_user):
    # ä»æ•°æ®å‡†å¤‡æ¨¡å—è·å–æ•°æ®
    data_dict = prepare_strategy_data(...)
    
    # è¿è¡Œå›æµ‹
    results, engine = run_backtest_from_data(data_dict)
    
    # ç”Ÿæˆå›¾è¡¨
    plot_json = engine.generate_plotly_json()
    
    return jsonify({
        "results": results,
        "plot_data": plot_json
    })
```

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. ä¾èµ–è¦æ±‚
```bash
# å¿…éœ€ä¾èµ–
pip install backtrader pandas numpy matplotlib

# å¯é€‰ä¾èµ–ï¼ˆç”¨äºäº¤äº’å¼å›¾è¡¨ï¼‰
pip install plotly
```

### 2. æ•°æ®æ ¼å¼è¦æ±‚
- CSVæ–‡ä»¶å¿…é¡»åŒ…å«: `ts_code`, `system.open`, `system.close`, `system.high`, `system.low`
- JSONæ–‡ä»¶å¿…é¡»åŒ…å«: `select_func`, `risk_control_func`, `param_columns`

### 3. ç­–ç•¥å‡½æ•°æ ¼å¼
ç­–ç•¥å‡½æ•°å¿…é¡»éµå¾ªç°æœ‰æ ¼å¼:
```python
def select_func(candidates, params, position_count, current_holdings, date, context=None):
    # é€‰è‚¡é€»è¾‘
    return selected_stocks

def risk_control_func(current_holdings, params, date, context=None):
    # é£æ§é€»è¾‘
    return safe_holdings
```

## ğŸš€ åç»­è®¡åˆ’

1. **å®æ—¶æ•°æ®æºé›†æˆ**: æ”¯æŒå®æ—¶è¡Œæƒ…æ•°æ®å›æµ‹
2. **æ›´å¤šåˆ†ææŒ‡æ ‡**: å¢åŠ æ›´ä¸°å¯Œçš„æ€§èƒ½åˆ†ææŒ‡æ ‡
3. **åŸºå‡†å¯¹æ¯”**: æ”¯æŒä¸åŸºå‡†æŒ‡æ•°çš„å¯¹æ¯”åˆ†æ
4. **å¤šç­–ç•¥ç»„åˆ**: æ”¯æŒå¤šç­–ç•¥ç»„åˆå›æµ‹
5. **å‚æ•°ä¼˜åŒ–**: æ”¯æŒç­–ç•¥å‚æ•°è‡ªåŠ¨ä¼˜åŒ–

## ğŸ“ ç›¸å…³æ–‡ä»¶

- `backtest_engine.py`: å›æµ‹å¼•æ“ä¸»æ–‡ä»¶
- `backtest_result.html`: åŒå‡çº¿ç­–ç•¥å›æµ‹å›¾è¡¨ï¼ˆæ¨¡æ‹Ÿæ•°æ®ï¼‰  
- `real_data_backtest_result.html`: åŒå‡çº¿ç­–ç•¥çœŸå®æ•°æ®å›¾è¡¨
- `macd_real_data_result.html`: MACDç­–ç•¥çœŸå®æ•°æ®å›¾è¡¨
- `backtrader/`: åŸå§‹å›æµ‹ä»£ç ç›®å½•
- `data_prepared/`: å‡†å¤‡å¥½çš„å›æµ‹æ•°æ®

## ğŸ”§ é‡è¦ä¿®å¤è¯´æ˜

### PlotlyçœŸå®æ•°æ®é›†æˆ (v1.1)

**é—®é¢˜**: ä¹‹å‰ç‰ˆæœ¬çš„plotlyå›¾è¡¨ä½¿ç”¨çš„æ˜¯æ¨¡æ‹Ÿéšæœºæ•°æ®ï¼Œæ²¡æœ‰åæ˜ çœŸå®çš„å›æµ‹ç»“æœã€‚

**è§£å†³æ–¹æ¡ˆ**:

1. æ–°å¢ `PortfolioValue` è‡ªå®šä¹‰åˆ†æå™¨ï¼Œåœ¨å›æµ‹è¿‡ç¨‹ä¸­è®°å½•æ¯æ—¥èµ„äº§ä»·å€¼
2. ä¿®æ”¹ `generate_plotly_html()` å’Œ `generate_plotly_json()` æ–¹æ³•ï¼Œä»çœŸå®å›æµ‹æ•°æ®ä¸­æå–ï¼š
   - æ¯æ—¥èµ„äº§ä»·å€¼å˜åŒ–
   - ç´¯è®¡æ”¶ç›Šç‡æ›²çº¿
   - å®é™…äº¤æ˜“æ—¥æœŸèŒƒå›´

**éªŒè¯ç»“æœ**:

- åŒå‡çº¿ç­–ç•¥ï¼š21å¤©çœŸå®æ•°æ®ï¼Œæ”¶ç›Šç‡-3.03%
- MACDç­–ç•¥ï¼š242å¤©çœŸå®æ•°æ®ï¼Œæ”¶ç›Šç‡+14.41%

ç°åœ¨plotlyå›¾è¡¨å‡†ç¡®åæ˜ äº†å›æµ‹çš„çœŸå®è¡¨ç°ï¼ŒåŒ…æ‹¬åŒYè½´æ˜¾ç¤ºï¼ˆèµ„äº§ä»·å€¼ + æ”¶ç›Šç‡%ï¼‰ã€‚

## ğŸ“ è”ç³»ä¿¡æ¯

å¦‚éœ€æŠ€æœ¯æ”¯æŒæˆ–åŠŸèƒ½æ‰©å±•ï¼Œè¯·å‚è€ƒé¡¹ç›®æ–‡æ¡£æˆ–è”ç³»å¼€å‘å›¢é˜Ÿã€‚